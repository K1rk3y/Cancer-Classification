# Still need to add actual image display 
# Working on extracting image from .h5


import tkinter as tk
from tkinter import filedialog
from tkinter import ttk
from PIL import ImageTk, Image
import numpy as np
import cv2

class ImageGUI:
   
    def __init__(self, master):
         self.master = master
         GUI_title = "Glioma Classification from MRI Images"
         self.master.title(GUI_title)
         
         # Specify fonts
         self.custom_font0 = ("Arial", 16, "bold", "underline") # Title
         self.custom_font1 = ("Arial", 12, "bold") # Heading
         self.custom_font2 = ("Arial", 12) # Body
    
         # Create a frame for the GUI and center it
         self.frame = tk.Frame(self.master)
         #self.frame.pack(expand=True, padx=10, pady=10)
         self.frame.grid(row=0, column=0, padx=10, pady=10)
         self.frame.grid_rowconfigure(0, weight=1)
         self.frame.grid_columnconfigure(0, weight=1)
         
         # Create a border for the GUI
         self.border = tk.Frame(self.frame, borderwidth=2, relief="groove")
         self.border.grid(row=0, column=0, sticky="nsew")
         
         # Create in-window title
         self.title_label = tk.Label(self.border, text=GUI_title, font=self.custom_font0)
         self.title_label.grid(row=0, column=0, columnspan=2, padx=5, pady=5)
        
         # Create a "Load Slice Directory" button
         self.loadslicedirectory_button = tk.Button(self.border, text="Load Slice Directory", command=self.load_slice_directory, font=self.custom_font1)
         self.loadslicedirectory_button.grid(row=1, column=0, columnspan=2, padx=5, pady=5)

         # Create annotation dropdown widget
         self.annotation_label = tk.Label(self.border, text="Annotation:", font=self.custom_font1)
         self.annotation_label.grid(row=2, column=0, padx=5, pady=5)
        
         annotation_options = ["OFF", "ON"]                                       # <----------------------- Define here or in function or global variable?
         self.annotation_dropdown = ttk.Combobox(self.border, values=annotation_options, font=self.custom_font2)
         self.annotation_dropdown.set(annotation_options[0]) # Set initial value to OFF
         self.annotation_dropdown.bind("<<ComboboxSelected>>", self.update_annotation_value) # Bind update_annotation_value function to change in annotation_dropdown
         self.annotation_dropdown.grid(row=2, column=1, padx=5, pady=5)

         # Create a channel selection dropdown widget
         self.channel_label = tk.Label(self.border, text="Select Channel:", font=self.custom_font1)
         self.channel_label.grid(row=3, column=0, padx=5, pady=5)
        
         channel_options = ["T2-FLAIR", "T1", "T1-Gd", "T2"]                                       # <----------------------- Define here or in function or global variable?
         self.channel_dropdown = ttk.Combobox(self.border, values=channel_options, font=self.custom_font2)
         self.channel_dropdown.set(channel_options[1]) # Set initial value to T1
         self.channel_dropdown.bind("<<ComboboxSelected>>", self.update_channel_selection) # Bind update_channel_selection function to change in channel_dropdown
         self.channel_dropdown.grid(row=3, column=1, padx=5, pady=5)

         # Label slice slider widget
         self.slicer_slider_label = tk.Label(self.border, text="Select Slice:", font=self.custom_font1)
         self.slicer_slider_label.grid(row=4, column=0, padx=5, pady=5)

         self.slice_slider = tk.Scale(self.border, from_=0, to=100, orient=tk.HORIZONTAL, length=200,  command=self.update_slice_value, font=self.custom_font2)
         self.slice_slider.grid(row=4, column=1, padx=5, pady=5)

         # Show image
            # Create space to show an image! and update based on slice, channel, and annotation inputs
         self.image_space = tk.Label(self.border, borderwidth=2, relief="sunken")
         self.image_space.grid(row=0, rowspan=8, column=2, columnspan=2, padx=5, pady=5)

         # Extract conventional features button
         self.extractconventionalfeatures_button = tk.Button(self.border, text="Extract Conventional Features", command=self.extract_conventional_features, font=self.custom_font1)
         self.extractconventionalfeatures_button.grid(row=5, column=0, columnspan=2, padx=5, pady=5)



    ## Load slice directory function and button ___________________________________________________________________________________
    def load_slice_directory(self):
        print()
        print("Selecting slice directory...")
        slice_directory = filedialog.askdirectory()
        print("    Directory selected!")
        print(f"    output: slice_directory = '{slice_directory}'")
        
        return slice_directory
    
    ## Function to handle annotation dropdown ___________________________________________________________________________________
    def update_annotation_value(self, event):
        print()
        annotation_value = self.annotation_dropdown.get()
        print(f"annotation_value: {annotation_value}")

        if annotation_value == "ON":
            print("    output: overlay segementation annotation on image")
        else:
            print("    output: display only image")
        
        return annotation_value

    ## Function to handle channel dropdown ___________________________________________________________________________________
    def update_channel_selection(self, event):
        print()
        channel_options = ["T2-FLAIR", "T1", "T1-Gd", "T2"]

        channel_selection = self.channel_dropdown.get()
        print(f"channel_selection: {channel_selection}")

        # Get index to encode channel selection from slice array
        channel_idx = channel_options.index(channel_selection)
        print(f"channel_idx: {channel_idx}")

        return channel_selection, channel_idx
    
    def update_slice_value(self, event):
        print()
        slice_value = self.slice_slider.get()
        print("update_slice_value(self)")
        print("    output: update variable slice_value")
        print(f"    slice_value: {slice_value}")
        
        return slice_value
    
    ## Show image function and button ___________________________________________________________________________________
    def show_image(self, slice_value, channel_idx, annotation_value):
        print()
        print("show_image(self, slice_value, channel_idx, annotation_value)")
        print("    output: display image of selected slice, channel and annotation overlay")

    # Extract conventional features function
    def extract_conventional_features(self):
        print()
        print("extract_conventional_features(self)")
        print("    output: calculate and save conventional features to csv")

# Run
root = tk.Tk()
app = ImageGUI(root)
root.mainloop()
